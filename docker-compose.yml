services:
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru
    # ports intentionally not exposed to host — access only via internal network
    volumes:
      - redisdata:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    deploy:
      resources:
        limits:
          memory: 256m
          cpus: "0.5"

  db:
    image: pgvector/pgvector:pg16
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-labpics}
      POSTGRES_USER: ${POSTGRES_USER:-app}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-app}
    # ports intentionally not exposed to host — access only via internal network
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-app} -d ${POSTGRES_DB:-labpics}"]
      interval: 5s
      timeout: 5s
      retries: 10
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: "1.0"

  server:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_URL: postgresql://${POSTGRES_USER:-app}:${POSTGRES_PASSWORD:-app}@db:5432/${POSTGRES_DB:-labpics}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      HOST: 0.0.0.0
      PORT: 8080
      AUTH_CREDENTIALS: ${AUTH_CREDENTIALS:?Set AUTH_CREDENTIALS as login:password}
      AUTH_USERNAME: ${AUTH_USERNAME:-}
      AUTH_PASSWORD: ${AUTH_PASSWORD:-}
      SESSION_COOKIE_NAME: ${SESSION_COOKIE_NAME:-sid}
      CSRF_COOKIE_NAME: ${CSRF_COOKIE_NAME:-csrf_token}
      LOGIN_RATE_LIMIT_MAX_ATTEMPTS: ${LOGIN_RATE_LIMIT_MAX_ATTEMPTS:-10}
      LOGIN_RATE_LIMIT_WINDOW_MINUTES: ${LOGIN_RATE_LIMIT_WINDOW_MINUTES:-15}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}
      CHATWOOT_BASE_URL: ${CHATWOOT_BASE_URL:-https://app.chatwoot.com}
      CHATWOOT_API_TOKEN: ${CHATWOOT_API_TOKEN:-replace-me}
      CHATWOOT_ACCOUNT_ID: ${CHATWOOT_ACCOUNT_ID:-123}
      CHATWOOT_CONVERSATIONS_LIMIT: ${CHATWOOT_CONVERSATIONS_LIMIT:-60}
      CHATWOOT_CONVERSATIONS_PER_PAGE: ${CHATWOOT_CONVERSATIONS_PER_PAGE:-25}
      CHATWOOT_PAGES_LIMIT: ${CHATWOOT_PAGES_LIMIT:-20}
      CHATWOOT_MESSAGES_LIMIT: ${CHATWOOT_MESSAGES_LIMIT:-300}
      CHATWOOT_LOOKBACK_DAYS: ${CHATWOOT_LOOKBACK_DAYS:-7}
      ATTIO_BASE_URL: ${ATTIO_BASE_URL:-https://api.attio.com}
      ATTIO_API_TOKEN: ${ATTIO_API_TOKEN:-}
      ATTIO_WORKSPACE_ID: ${ATTIO_WORKSPACE_ID:-}
      ATTIO_SYNC_LIMIT: ${ATTIO_SYNC_LIMIT:-200}
      ATTIO_MOCK_MODE: ${ATTIO_MOCK_MODE:-1}
      LINEAR_BASE_URL: ${LINEAR_BASE_URL:-https://api.linear.app/graphql}
      LINEAR_API_TOKEN: ${LINEAR_API_TOKEN:-}
      LINEAR_WORKSPACE_ID: ${LINEAR_WORKSPACE_ID:-}
      LINEAR_SYNC_LIMIT: ${LINEAR_SYNC_LIMIT:-200}
      LINEAR_MOCK_MODE: ${LINEAR_MOCK_MODE:-1}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-replace-me}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-text-embedding-3-small}
      EMBEDDING_DIM: ${EMBEDDING_DIM:-1536}
      EMBED_BATCH_SIZE: ${EMBED_BATCH_SIZE:-100}
      OPENAI_EMBED_MAX_INPUTS: ${OPENAI_EMBED_MAX_INPUTS:-100}
      OPENAI_TIMEOUT_MS: ${OPENAI_TIMEOUT_MS:-20000}
      EMBED_STALE_RECOVERY_MINUTES: ${EMBED_STALE_RECOVERY_MINUTES:-30}
      CHUNK_SIZE: ${CHUNK_SIZE:-1000}
      MIN_EMBED_CHARS: ${MIN_EMBED_CHARS:-30}
      SEARCH_IVFFLAT_PROBES: ${SEARCH_IVFFLAT_PROBES:-10}
      SEARCH_HNSW_EF_SEARCH: ${SEARCH_HNSW_EF_SEARCH:-40}
      STORAGE_BUDGET_GB: ${STORAGE_BUDGET_GB:-20}
      STORAGE_ALERT_THRESHOLD_PCT: ${STORAGE_ALERT_THRESHOLD_PCT:-85}
    ports:
      - "${API_PORT:-8080}:8080"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: "1.0"

  worker:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    restart: unless-stopped
    command: ["npm", "run", "worker:loop"]
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_URL: postgresql://${POSTGRES_USER:-app}:${POSTGRES_PASSWORD:-app}@db:5432/${POSTGRES_DB:-labpics}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      WORKER_INTERVAL_SECONDS: ${WORKER_INTERVAL_SECONDS:-60}
      WORKER_TICK_LIMIT: ${WORKER_TICK_LIMIT:-25}
      CHATWOOT_BASE_URL: ${CHATWOOT_BASE_URL:-https://app.chatwoot.com}
      CHATWOOT_API_TOKEN: ${CHATWOOT_API_TOKEN:-replace-me}
      CHATWOOT_ACCOUNT_ID: ${CHATWOOT_ACCOUNT_ID:-123}
      CHATWOOT_CONVERSATIONS_LIMIT: ${CHATWOOT_CONVERSATIONS_LIMIT:-60}
      CHATWOOT_CONVERSATIONS_PER_PAGE: ${CHATWOOT_CONVERSATIONS_PER_PAGE:-25}
      CHATWOOT_PAGES_LIMIT: ${CHATWOOT_PAGES_LIMIT:-20}
      CHATWOOT_MESSAGES_LIMIT: ${CHATWOOT_MESSAGES_LIMIT:-300}
      CHATWOOT_LOOKBACK_DAYS: ${CHATWOOT_LOOKBACK_DAYS:-7}
      ATTIO_BASE_URL: ${ATTIO_BASE_URL:-https://api.attio.com}
      ATTIO_API_TOKEN: ${ATTIO_API_TOKEN:-}
      ATTIO_WORKSPACE_ID: ${ATTIO_WORKSPACE_ID:-}
      ATTIO_SYNC_LIMIT: ${ATTIO_SYNC_LIMIT:-200}
      ATTIO_MOCK_MODE: ${ATTIO_MOCK_MODE:-1}
      LINEAR_BASE_URL: ${LINEAR_BASE_URL:-https://api.linear.app/graphql}
      LINEAR_API_TOKEN: ${LINEAR_API_TOKEN:-}
      LINEAR_WORKSPACE_ID: ${LINEAR_WORKSPACE_ID:-}
      LINEAR_SYNC_LIMIT: ${LINEAR_SYNC_LIMIT:-200}
      LINEAR_MOCK_MODE: ${LINEAR_MOCK_MODE:-1}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-replace-me}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-text-embedding-3-small}
      EMBEDDING_DIM: ${EMBEDDING_DIM:-1536}
      EMBED_BATCH_SIZE: ${EMBED_BATCH_SIZE:-100}
      OPENAI_EMBED_MAX_INPUTS: ${OPENAI_EMBED_MAX_INPUTS:-100}
      OPENAI_TIMEOUT_MS: ${OPENAI_TIMEOUT_MS:-20000}
      EMBED_STALE_RECOVERY_MINUTES: ${EMBED_STALE_RECOVERY_MINUTES:-30}
      CHUNK_SIZE: ${CHUNK_SIZE:-1000}
      MIN_EMBED_CHARS: ${MIN_EMBED_CHARS:-30}
      SEARCH_IVFFLAT_PROBES: ${SEARCH_IVFFLAT_PROBES:-10}
      SEARCH_HNSW_EF_SEARCH: ${SEARCH_HNSW_EF_SEARCH:-40}
      STORAGE_BUDGET_GB: ${STORAGE_BUDGET_GB:-20}
      STORAGE_ALERT_THRESHOLD_PCT: ${STORAGE_ALERT_THRESHOLD_PCT:-85}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'worker-loop' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: "1.0"

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-/api}
        API_UPSTREAM_URL: ${API_UPSTREAM_URL:-http://server:8080}
        NEXT_PUBLIC_CSRF_COOKIE_NAME: ${NEXT_PUBLIC_CSRF_COOKIE_NAME:-csrf_token}
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-/api}
      API_UPSTREAM_URL: ${API_UPSTREAM_URL:-http://server:8080}
      NEXT_PUBLIC_CSRF_COOKIE_NAME: ${NEXT_PUBLIC_CSRF_COOKIE_NAME:-csrf_token}
    ports:
      - "${WEB_PORT:-3000}:3000"
    depends_on:
      - server
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:3000/ || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: "1.0"

  edge:
    image: caddy:2.9.1-alpine
    profiles: ["edge"]
    restart: unless-stopped
    environment:
      DOMAIN: ${DOMAIN:-dashboard.lab.pics}
      API_UPSTREAM: ${API_UPSTREAM:-server:8080}
      WEB_UPSTREAM: ${WEB_UPSTREAM:-web:3000}
      EDGE_BASIC_AUTH_ENABLED: ${EDGE_BASIC_AUTH_ENABLED:-false}
      EDGE_BASIC_AUTH_USER: ${EDGE_BASIC_AUTH_USER:-}
      EDGE_BASIC_AUTH_PASSWORD_HASH: ${EDGE_BASIC_AUTH_PASSWORD_HASH:-}
    ports:
      - "${EDGE_HTTP_PORT:-80}:80"
      - "${EDGE_HTTPS_PORT:-443}:443"
    volumes:
      - ./infra/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - web
    deploy:
      resources:
        limits:
          memory: 128m
          cpus: "0.25"

  telegram-bot:
    build:
      context: ./apps/telegram-bot
      target: dev
    profiles: ["telegram-bot"]
    restart: unless-stopped
    environment:
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      DATABASE_URL: postgresql://${POSTGRES_USER:-app}:${POSTGRES_PASSWORD:-app}@db:5432/${POSTGRES_DB:-labpics}
      COMPOSIO_API_KEY: ${COMPOSIO_API_KEY:-}
      BOT_ALLOWED_TELEGRAM_USER_IDS: ${BOT_ALLOWED_TELEGRAM_USER_IDS:-}
    ports:
      - "${BOT_PORT:-8787}:8787"
    deploy:
      resources:
        limits:
          memory: 256m
          cpus: "0.5"

volumes:
  pgdata:
  redisdata:
  caddy_data:
  caddy_config:
