services:
  db:
    image: pgvector/pgvector:pg16
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-labpics}
      POSTGRES_USER: ${POSTGRES_USER:-app}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-app}
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-app} -d ${POSTGRES_DB:-labpics}"]
      interval: 5s
      timeout: 5s
      retries: 10

  server:
    build:
      context: ./server
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_URL: postgresql://${POSTGRES_USER:-app}:${POSTGRES_PASSWORD:-app}@db:5432/${POSTGRES_DB:-labpics}
      HOST: 0.0.0.0
      PORT: 8080
      AUTH_CREDENTIALS: ${AUTH_CREDENTIALS:-admin:admin}
      AUTH_USERNAME: ${AUTH_USERNAME:-admin}
      AUTH_PASSWORD: ${AUTH_PASSWORD:-admin}
      SESSION_COOKIE_NAME: ${SESSION_COOKIE_NAME:-sid}
      CSRF_COOKIE_NAME: ${CSRF_COOKIE_NAME:-csrf_token}
      LOGIN_RATE_LIMIT_MAX_ATTEMPTS: ${LOGIN_RATE_LIMIT_MAX_ATTEMPTS:-10}
      LOGIN_RATE_LIMIT_WINDOW_MINUTES: ${LOGIN_RATE_LIMIT_WINDOW_MINUTES:-15}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}
      CHATWOOT_BASE_URL: ${CHATWOOT_BASE_URL:-https://app.chatwoot.com}
      CHATWOOT_API_TOKEN: ${CHATWOOT_API_TOKEN:-replace-me}
      CHATWOOT_ACCOUNT_ID: ${CHATWOOT_ACCOUNT_ID:-123}
      CHATWOOT_CONVERSATIONS_LIMIT: ${CHATWOOT_CONVERSATIONS_LIMIT:-60}
      CHATWOOT_CONVERSATIONS_PER_PAGE: ${CHATWOOT_CONVERSATIONS_PER_PAGE:-25}
      CHATWOOT_PAGES_LIMIT: ${CHATWOOT_PAGES_LIMIT:-20}
      CHATWOOT_MESSAGES_LIMIT: ${CHATWOOT_MESSAGES_LIMIT:-300}
      CHATWOOT_LOOKBACK_DAYS: ${CHATWOOT_LOOKBACK_DAYS:-7}
      ATTIO_BASE_URL: ${ATTIO_BASE_URL:-https://api.attio.com}
      ATTIO_API_TOKEN: ${ATTIO_API_TOKEN:-}
      ATTIO_WORKSPACE_ID: ${ATTIO_WORKSPACE_ID:-}
      ATTIO_SYNC_LIMIT: ${ATTIO_SYNC_LIMIT:-200}
      ATTIO_MOCK_MODE: ${ATTIO_MOCK_MODE:-1}
      LINEAR_BASE_URL: ${LINEAR_BASE_URL:-https://api.linear.app/graphql}
      LINEAR_API_TOKEN: ${LINEAR_API_TOKEN:-}
      LINEAR_WORKSPACE_ID: ${LINEAR_WORKSPACE_ID:-}
      LINEAR_SYNC_LIMIT: ${LINEAR_SYNC_LIMIT:-200}
      LINEAR_MOCK_MODE: ${LINEAR_MOCK_MODE:-1}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-replace-me}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-text-embedding-3-small}
      EMBEDDING_DIM: ${EMBEDDING_DIM:-1536}
      EMBED_BATCH_SIZE: ${EMBED_BATCH_SIZE:-100}
      OPENAI_EMBED_MAX_INPUTS: ${OPENAI_EMBED_MAX_INPUTS:-100}
      OPENAI_TIMEOUT_MS: ${OPENAI_TIMEOUT_MS:-20000}
      EMBED_STALE_RECOVERY_MINUTES: ${EMBED_STALE_RECOVERY_MINUTES:-30}
      CHUNK_SIZE: ${CHUNK_SIZE:-1000}
      MIN_EMBED_CHARS: ${MIN_EMBED_CHARS:-30}
      SEARCH_IVFFLAT_PROBES: ${SEARCH_IVFFLAT_PROBES:-10}
      SEARCH_HNSW_EF_SEARCH: ${SEARCH_HNSW_EF_SEARCH:-40}
      STORAGE_BUDGET_GB: ${STORAGE_BUDGET_GB:-20}
      STORAGE_ALERT_THRESHOLD_PCT: ${STORAGE_ALERT_THRESHOLD_PCT:-85}
    ports:
      - "${API_PORT:-8080}:8080"
    depends_on:
      db:
        condition: service_healthy

  worker:
    build:
      context: ./server
    restart: unless-stopped
    command: npm run worker:loop
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_URL: postgresql://${POSTGRES_USER:-app}:${POSTGRES_PASSWORD:-app}@db:5432/${POSTGRES_DB:-labpics}
      WORKER_INTERVAL_SECONDS: ${WORKER_INTERVAL_SECONDS:-60}
      WORKER_TICK_LIMIT: ${WORKER_TICK_LIMIT:-25}
      CHATWOOT_BASE_URL: ${CHATWOOT_BASE_URL:-https://app.chatwoot.com}
      CHATWOOT_API_TOKEN: ${CHATWOOT_API_TOKEN:-replace-me}
      CHATWOOT_ACCOUNT_ID: ${CHATWOOT_ACCOUNT_ID:-123}
      CHATWOOT_CONVERSATIONS_LIMIT: ${CHATWOOT_CONVERSATIONS_LIMIT:-60}
      CHATWOOT_CONVERSATIONS_PER_PAGE: ${CHATWOOT_CONVERSATIONS_PER_PAGE:-25}
      CHATWOOT_PAGES_LIMIT: ${CHATWOOT_PAGES_LIMIT:-20}
      CHATWOOT_MESSAGES_LIMIT: ${CHATWOOT_MESSAGES_LIMIT:-300}
      CHATWOOT_LOOKBACK_DAYS: ${CHATWOOT_LOOKBACK_DAYS:-7}
      ATTIO_BASE_URL: ${ATTIO_BASE_URL:-https://api.attio.com}
      ATTIO_API_TOKEN: ${ATTIO_API_TOKEN:-}
      ATTIO_WORKSPACE_ID: ${ATTIO_WORKSPACE_ID:-}
      ATTIO_SYNC_LIMIT: ${ATTIO_SYNC_LIMIT:-200}
      ATTIO_MOCK_MODE: ${ATTIO_MOCK_MODE:-1}
      LINEAR_BASE_URL: ${LINEAR_BASE_URL:-https://api.linear.app/graphql}
      LINEAR_API_TOKEN: ${LINEAR_API_TOKEN:-}
      LINEAR_WORKSPACE_ID: ${LINEAR_WORKSPACE_ID:-}
      LINEAR_SYNC_LIMIT: ${LINEAR_SYNC_LIMIT:-200}
      LINEAR_MOCK_MODE: ${LINEAR_MOCK_MODE:-1}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-replace-me}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-text-embedding-3-small}
      EMBEDDING_DIM: ${EMBEDDING_DIM:-1536}
      EMBED_BATCH_SIZE: ${EMBED_BATCH_SIZE:-100}
      OPENAI_EMBED_MAX_INPUTS: ${OPENAI_EMBED_MAX_INPUTS:-100}
      OPENAI_TIMEOUT_MS: ${OPENAI_TIMEOUT_MS:-20000}
      EMBED_STALE_RECOVERY_MINUTES: ${EMBED_STALE_RECOVERY_MINUTES:-30}
      CHUNK_SIZE: ${CHUNK_SIZE:-1000}
      MIN_EMBED_CHARS: ${MIN_EMBED_CHARS:-30}
      SEARCH_IVFFLAT_PROBES: ${SEARCH_IVFFLAT_PROBES:-10}
      SEARCH_HNSW_EF_SEARCH: ${SEARCH_HNSW_EF_SEARCH:-40}
      STORAGE_BUDGET_GB: ${STORAGE_BUDGET_GB:-20}
      STORAGE_ALERT_THRESHOLD_PCT: ${STORAGE_ALERT_THRESHOLD_PCT:-85}
    depends_on:
      db:
        condition: service_healthy
      server:
        condition: service_started

  web:
    build:
      context: ./web
      args:
        NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-/api}
        API_UPSTREAM_URL: ${API_UPSTREAM_URL:-http://server:8080}
        NEXT_PUBLIC_CSRF_COOKIE_NAME: ${NEXT_PUBLIC_CSRF_COOKIE_NAME:-csrf_token}
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-/api}
      API_UPSTREAM_URL: ${API_UPSTREAM_URL:-http://server:8080}
      NEXT_PUBLIC_CSRF_COOKIE_NAME: ${NEXT_PUBLIC_CSRF_COOKIE_NAME:-csrf_token}
    ports:
      - "${WEB_PORT:-3000}:3000"
    depends_on:
      - server

  edge:
    image: caddy:2.9.1-alpine
    profiles: ["edge"]
    restart: unless-stopped
    environment:
      DOMAIN: ${DOMAIN:-dashboard.lab.pics}
      API_UPSTREAM: ${API_UPSTREAM:-server:8080}
      WEB_UPSTREAM: ${WEB_UPSTREAM:-web:3000}
      EDGE_BASIC_AUTH_ENABLED: ${EDGE_BASIC_AUTH_ENABLED:-false}
      EDGE_BASIC_AUTH_USER: ${EDGE_BASIC_AUTH_USER:-}
      EDGE_BASIC_AUTH_PASSWORD_HASH: ${EDGE_BASIC_AUTH_PASSWORD_HASH:-}
    ports:
      - "${EDGE_HTTP_PORT:-80}:80"
      - "${EDGE_HTTPS_PORT:-443}:443"
    volumes:
      - ./infra/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - web

volumes:
  pgdata:
  caddy_data:
  caddy_config:
