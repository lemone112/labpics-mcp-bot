# Labpics MCP Bot (v2) ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è AI‚Äë–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ Labpics

–≠—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ‚Äî production‚Äë–∫–æ–¥ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ Labpics, –∫–æ—Ç–æ—Ä—ã–π:

- –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ (Chatwoot) –≤ **–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—É—é –ø–∞–º—è—Ç—å** (Supabase)
- –∏–∑–≤–ª–µ–∫–∞–µ—Ç **–¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏ (commitments)** –∏ **—Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏**
- –ø–æ–º–æ–≥–∞–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å **PM (Linear)** –∏ **CRM (Attio)**
- –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–µ—Ä–µ–∑ **Telegram**

> –≠—Ç–æ—Ç README –Ω–∞–ø–∏—Å–∞–Ω —Ç–∞–∫, —á—Ç–æ–±—ã –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–æ–∂–Ω–æ –±—ã–ª–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å **–∞–±—Å–æ–ª—é—Ç–Ω–æ –≤—Å—ë –≤–∞–∂–Ω–æ–µ**: –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, –¥–∞–Ω–Ω—ã–µ, –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, runbooks, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã.

---

## –õ–µ–≥–µ–Ω–¥–∞: —Å—Ç–∞—Ç—É—Å—ã –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

**–°—Ç–∞—Ç—É—Å—ã:**
- ‚úÖ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- üß™ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–∞—Å—Ç–∏—á–Ω–æ / –ø—Ä–æ—Ç–æ—Ç–∏–ø
- üó∫Ô∏è –ø–ª–∞–Ω (–æ–ø–∏—Å–∞–Ω–æ –∫–∞–∫ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:**
- **P0** ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏/–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è/—Å—Ç–æ–∏–º–æ—Å—Ç–∏
- **P1** ‚Äî –¥–∞—ë—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –±–∏–∑–Ω–µ—Å‚Äë—Ü–µ–Ω–Ω–æ—Å—Ç—å PM/CRM
- **P2** ‚Äî —É—Å–∏–ª–∏—Ç–µ–ª–∏/—É–¥–æ–±—Å—Ç–≤–æ/–ø—Ä–∏—è—Ç–Ω–æ—Å—Ç–∏

---

## 0) TL;DR (–∫–∞–∫ —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ 20 —Å—Ç—Ä–æ–∫)

1) –ö–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –≤ Chatwoot.
2) `cw-sync` —Ä–µ–≥—É–ª—è—Ä–Ω–æ –∑–∞–±–∏—Ä–∞–µ—Ç conversations/messages –∏ –ø–∏—à–µ—Ç raw –¥–∞–Ω–Ω—ã–µ –≤ `cw_*` —Ç–∞–±–ª–∏—Ü—ã Supabase.
3) `cw-sync` —Ä–µ–∂–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞–Ω–∫–∏ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `rag_chunks`.
4) `cw-sync` —Å—á–∏—Ç–∞–µ—Ç embeddings (OpenAI) –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `rag_chunks.embedding` (pgvector).
5) PM/–∞–∫–∫–∞—É–Ω—Ç‚Äë–º–µ–Ω–µ–¥–∂–µ—Ä –æ–±—â–∞–µ—Ç—Å—è —Å –±–æ—Ç–æ–º –≤ Telegram (`tgbot`).
6) `tgbot` —Ö—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–µ–∫—Ç, pending input) –≤ Supabase.
7) `tgbot` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ `agent-gw` —á–µ—Ä–µ–∑ Service Binding –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç payload HMAC.
8) `agent-gw` —Å—Ç—Ä–æ–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞ (links + –ø–∞–º—è—Ç—å + commitments).
9) `agent-gw` –≤—ã–ø–æ–ª–Ω—è–µ—Ç intent: –ø–æ–∏—Å–∫ / –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–µ–π / –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π.
10) –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ Telegram –∫–∞–∫ —Ç–µ–∫—Å—Ç + inline‚Äë–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞.

---

## 1) –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (Cloudflare Workers)

### 1.1 `tgbot` ‚Äî Telegram UI / –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
**–†–æ–ª—å:** UI, —Ä–æ—É—Ç–∏–Ω–≥, state, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∏.

‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- Telegram webhook
- UI: Home / Projects / Dashboard / Search / –î–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏
- pending input state (`user_input_state`)
- active project per user (`user_project_state`)
- —Å–µ—Ä–≤–∏—Å–Ω—ã–π –≤—ã–∑–æ–≤ `agent-gw` —á–µ—Ä–µ–∑ binding `AGENT_GW`
- –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ endpoints: `/__whoami`, `/__env`, `/health`

üó∫Ô∏è –ü—Ä–∏–Ω—Ü–∏–ø:
- `tgbot` –ù–ï –¥–µ–ª–∞–µ—Ç LLM –∏ —Ç—è–∂—ë–ª—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- `tgbot` –ù–ï –¥–æ–ª–∂–µ–Ω –Ω–∞–ø—Ä—è–º—É—é –¥–µ—Ä–≥–∞—Ç—å Attio/Linear (–≤ v2), —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å jobs —á–µ—Ä–µ–∑ –∞–≥–µ–Ω—Ç–∞

### 1.2 `agent-gw` ‚Äî –∞–≥–µ–Ω—Ç (intent + –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã + –∫–æ–Ω—Ç–µ–∫—Å—Ç)
**–†–æ–ª—å:** ‚Äú–º–æ–∑–≥‚Äù —Å–∏—Å—Ç–µ–º—ã. –í v2 –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ –≤—ã–¥–µ–ª—è–µ–º `agent-core`.

‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- intent: commitments vs search (MVP)
- commitments extraction —á–µ—Ä–µ–∑ LLM (OpenAI) ‚Üí –∑–∞–ø–∏—Å—å –≤ `project_commitments`
- –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ upsert commitments (dedup –∫–æ–Ω—Ñ–ª–∏–∫—Ç –Ω–µ –ª–æ–º–∞–µ—Ç UX)
- –≤—ã–¥–∞—á–∞ –æ—Ç–≤–µ—Ç–æ–≤ –≤ TG –∫–∞–∫ `{text, keyboard}`

üß™ –ß–∞—Å—Ç–∏—á–Ω–æ:
- –ø–æ–∏—Å–∫ –ø–æ –ø–∞–º—è—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞ (–ø–æ–∫–∞ MVP)
- –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (Linear/Attio) ‚Äî –∫–∞–∫ —Å—Ü–µ–Ω–∞—Ä–∏–∏/–ø—Ä–æ—Ç–æ—Ç–∏–ø—ã, –Ω–æ –Ω–µ –ø–æ–ª–Ω—ã–π –ø—Ä–æ–¥‚Äë–ø–æ—Ç–æ–∫

üó∫Ô∏è –í v2:
- agent-core = intent-router + context-builder + tool-orchestrator
- tools = –º–∞–ª–µ–Ω—å–∫–∏–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ —Å—Ç—Ä–æ–≥–∏–º–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º–∏

### 1.3 `cw-sync` ‚Äî ingestion (Chatwoot ‚Üí Supabase + embeddings)
**–†–æ–ª—å:** —Å–±–æ—Ä –ø–µ—Ä–µ–ø–∏—Å–æ–∫ + –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –ø–∞–º—è—Ç–∏.

‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- polling Chatwoot
- watermark/cursor
- –∑–∞–ø–∏—Å—å raw: `cw_conversations`, `cw_messages`
- —á–∞–Ω–∫–∏–Ω–≥ ‚Üí `rag_chunks` (status pending)
- embeddings batch ‚Üí `rag_chunks.embedding` (status ready)
- endpoints: `/health`, `/sync`, `/embed` (Bearer `SYNC_TOKEN`)
- scheduled: –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ embedd‚Äô–∏–Ω–≥‚Äë–¥–æ—Å–æ–±–∏—Ä–∞–Ω–∏–µ

üó∫Ô∏è –í v2:
- —Å—Ç—Ä–æ–≥–∏–µ –ª–∏–º–∏—Ç—ã –∏ rate limit –∑–∞—â–∏—Ç–∞
- batch embeddings ‚â§ 100 –∑–∞ –≤—ã–∑–æ–≤
- –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å `embedding-queue`

---

## 2) –°–∏—Å—Ç–µ–º—ã (–≤–Ω–µ—à–Ω–∏–µ) –∏ –∏—Ö —Ä–æ–ª—å

### Chatwoot (–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏)
- –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –ø–æ —Ç–µ–∫—Å—Ç—É –∏ –¥–∏–Ω–∞–º–∏–∫–µ –æ–±—â–µ–Ω–∏—è
- ingestion –≤ Supabase –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `cw-sync`

### Supabase (–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å + pgvector)
- —Ö—Ä–∞–Ω–∏—Ç –ø—Ä–æ–µ–∫—Ç—ã, –ª–∏–Ω–∫–æ–≤–∫—É, commitments, raw chat –∏ rag_chunks
- —è–≤–ª—è–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º data backbone

### Linear (PM)
- –∑–∞–¥–∞—á–∏ –∏ –ø—Ä–æ–µ–∫—Ç—ã, —Å–æ–∑–¥–∞–≤–∞–µ–º—ã–µ –∏–∑ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–µ–π / action items

### Attio (CRM)
- company/person/deal
- –≤ v2: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–∑ –ø–µ—Ä–µ–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ patch flow

---

## 3) –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö (—Ç–µ–∫—É—â–∞—è v1 + –ø–ª–∞–Ω v2)

### 3.1 –¢–µ–∫—É—â–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã (v1)

**–ü—Ä–æ–µ–∫—Ç—ã/—Å–æ—Å—Ç–æ—è–Ω–∏–µ/–ª–∏–Ω–∫–æ–≤–∫–∞:**
- `public.projects`
- `public.project_links` (–∫–ª—é—á–µ–≤–æ–π —Å–ª–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π)
- `public.project_conversation_map`
- `public.telegram_users`
- `public.user_project_state`
- `public.user_input_state`

**Chatwoot raw:**
- `public.cw_conversations`
- `public.cw_messages`
- `public.cw_contacts`
- `public.cw_webhook_events` (—Ç–∞–±–ª–∏—Ü–∞ –µ—Å—Ç—å; ingestion —Å–µ–π—á–∞—Å polling)

**RAG:**
- `public.rag_chunks` (pgvector, embedding_status)

**Commitments:**
- `public.project_commitments`

**Automation/ops:**
- `public.automation_settings`
- `public.automation_jobs`
- `public.audit_log`
- `public.integration_watermarks`
- `public.rag_chatwoot_sync_state` (legacy)
- `public.sync_watermarks` (–Ω–æ–≤–µ–µ)

### 3.2 –°–∏–≥–Ω–∞–ª—ã –∏–∑ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö (—Ñ–∞–∫—Ç—ã)

–ò–∑ `project_links` —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–∏–ø—ã:
- `linear.linear_issue` (–Ω–µ—Å–∫–æ–ª—å–∫–æ)
- `attio.company`, `attio.deal`, `attio.person`
- `chatwoot.contact`, `chatwoot.conversation`, `chatwoot.message`

–≠—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç: –ø—Ä–æ–¥—É–∫—Ç —Ä–µ–∞–ª—å–Ω–æ –Ω–∞—Ü–µ–ª–µ–Ω –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é CRM/PM –ø–æ–≤–µ—Ä—Ö –ø–µ—Ä–µ–ø–∏—Å–æ–∫.

### 3.3 Multi-tenant (v2) ‚Äî –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å—Ç—É–¥–∏–∏

–ú—ã –æ—Å—Ç–∞—ë–º—Å—è **–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –ø—Ä–æ–¥—É–∫—Ç–æ–º**, –Ω–æ —Å—Ç—Ä–æ–∏–º multi-tenant –∫–∞–∫ ‚Äúmulti‚Äëworkspace‚Äù:
- —Ä–∞–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã/–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è/—é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –ª–∏—Ü–∞ —Å—Ç—É–¥–∏–∏
- –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–∑–æ–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –ª–∏–º–∏—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ tenant boundary:** org = **Attio workspace** (CRM‚Äë–∫–æ–Ω—Ç—É—Ä).

üó∫Ô∏è –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã:
- `organizations(id, name, billing_plan, meta, created_at)`
- `memberships(user_id, organization_id, role)`
- `users(id, display_name, meta, created_at)`

üó∫Ô∏è –ò–∑–º–µ–Ω–µ–Ω–∏—è:
- `projects` ‚Üí –¥–æ–±–∞–≤–∏—Ç—å `organization_id NOT NULL`

---

## 4) –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è (–≤–∞–∂–Ω–æ –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)

### 4.1 –ì–ª–æ–±–∞–ª—å–Ω—ã–µ ID (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è)

- Chatwoot conversation: `cw:<account_id>:<conversation_id>`
- Chatwoot message: `cwmsg:<account_id>:<message_id>`

–≠—Ç–æ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ `cw-sync`.

### 4.2 –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è commitments

–í –ë–î –µ—Å—Ç—å dedup (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å), –ø–æ—ç—Ç–æ–º—É:
- commitments upsert –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º
- –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –Ω–µ –¥–æ–ª–∂–Ω—ã –ª–æ–º–∞—Ç—å UX

‚úÖ –£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ `agent-gw`.

---

## 5) –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã v2 (agent-core / tool-layer)

> –¶–µ–ª—å: tools –Ω–µ –¥–æ–ª–∂–Ω—ã –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç UI, –∞ UI –Ω–µ –¥–æ–ª–∂–µ–Ω –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

### 5.1 –ö–æ–Ω—Ç—Ä–∞–∫—Ç –∑–∞–ø—Ä–æ—Å–∞ `tgbot ‚Üí agent-gw`

**–í—Ö–æ–¥ (payload):**
- `request_id` (correlation_id)
- `telegram_user_id`
- `chat_id`
- `active_project_id`
- `user_text`
- `context`:
  - `project` (–º–∏–Ω–∏–º—É–º: id/name/status)
  - `links[]` (Attio/Linear/Chatwoot)
  - (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —Ç–æ–ø‚Äë—á–∞–Ω–∫–∏ –ø–∞–º—è—Ç–∏

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** HMAC –ø–æ–¥–ø–∏—Å—å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º `x-signature`.

**–í—ã—Ö–æ–¥ (agent response):**
- `text` (HTML –¥–ª—è Telegram)
- `keyboard` (inline keyboard)
- (–≤ v2) `actions[]` (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π)

### 5.2 –ö–æ–Ω—Ç—Ä–∞–∫—Ç tool

–ö–∞–∂–¥—ã–π tool:
- –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `tool_input` (JSON)
- –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `tool_output` (JSON)
- –ø–∏—à–µ—Ç usage_event
- –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç intent‚Äë–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏

–ü—Ä–∏–º–µ—Ä—ã tools v2:
- `search_project_memory`
- `extract_commitments`
- `suggest_attio_patch`
- `apply_attio_patch` (—á–µ—Ä–µ–∑ automation job)
- `create_linear_issue`
- `update_linear_issue`
- `generate_weekly_digest`

---

## 6) RAG v2 (–∫–∞–∫ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å)

### P0: –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ embedding retrieval

**–¶–µ–ª—å:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pgvector RPC `match_rag_chunks` (—É–∂–µ –µ—Å—Ç—å –≤ –ë–î) –≤–º–µ—Å—Ç–æ `ilike`.

**Pipeline:**
1) embedding –∑–∞–ø—Ä–æ—Å–∞
2) vector similarity topK=50
3) –¥–µ–¥—É–ø –ø–æ `message_global_id`
4) top 15 chunks
5) –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ LLM rerank

**–õ–∏–º–∏—Ç—ã:**
- `max_chunks = 15`
- `max_context_tokens = 6000`

---

## 7) –û—á–µ—Ä–µ–¥–∏ –∏ automation-worker (v2)

### P0: –≤—Å–µ –≤–Ω–µ—à–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ jobs

üó∫Ô∏è –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- `automation-queue` (Cloudflare Queue)
- `automation-worker` (–Ω–æ–≤—ã–π Worker)

**automation-worker –¥–µ–ª–∞–µ—Ç:**
- –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ `automation_jobs`
- retries —Å backoff
- DLQ
- —Å—Ç—Ä–æ–≥—É—é –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

**Idempotency:**
- `automation_jobs.idempotency_key`
- —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å `(organization_id, idempotency_key)`

---

## 8) Commitments lifecycle UI (v2)

### P1: –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å commitments –≤ —É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –æ–±—ä–µ–∫—Ç—ã

Telegram UI:
- done
- cancel
- assign owner
- set due
- create Linear issue

---

## 9) CRM Patch Flow (Attio)

### P1: –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ CRM –∏–∑ –ø–µ—Ä–µ–ø–∏—Å–æ–∫

–ü–æ—Ç–æ–∫:
1) –∞–≥–µ–Ω—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç patch diff (—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ)
2) Telegram –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç diff
3) Apply / Ignore
4) Apply ‚Üí `automation_job`
5) `audit_log` + evidence

---

## 10) Weekly Digest

### P1: —É–ø—Ä–∞–≤–ª—è–µ–º–∞—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å

–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
- –∑–∞–∫—Ä—ã—Ç—ã–µ commitments
- –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ
- –Ω–æ–≤—ã–µ —Ä–∏—Å–∫–∏
- –∏–Ω—Å–∞–π—Ç—ã
- Linear summary

–ö–∞–Ω–∞–ª—ã:
- Telegram
- –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ Linear comment

–ó–∞–ø—É—Å–∫:
- cron
- manual

---

## 11) Observability –∏ cost control

### P0: correlation + usage events

**Observability:**
- correlation_id –≤–æ –≤—Å–µ—Ö –ª–æ–≥–∞—Ö
- structured JSON logs
- p95 latency
- queue depth
- automation failure rate

**Cost control:**
- `usage_events` + –ª–∏–º–∏—Ç—ã –Ω–∞ org
- –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ (intent ‚Üí –¥–µ—à—ë–≤–∞—è; reasoning ‚Üí –æ—Å–Ω–æ–≤–Ω–∞—è)
- –ª–∏–º–∏—Ç—ã: max tool calls / max tokens / max commitments per run

---

## 12) Runbooks (–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)

### 12.1 Telegram: dev‚Äë–±–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
1) –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `tgbot-dev/health`
2) –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `tgbot-dev/__env` (–≤–∏–¥–∏—Ç –ª–∏ TELEGRAM_WEBHOOK_PATH)
3) –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `getWebhookInfo` —É dev‚Äë–±–æ—Ç–∞
4) –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook –Ω–∞ `https://tgbot-dev...<path>`

### 12.2 cw-sync: –Ω–µ —Ä–∞—Å—Ç—É—Ç embeddings
1) –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `/health`
2) –≤—ã–∑–≤–∞—Ç—å `/embed` (Bearer)
3) –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `rag_chunks` –ø–æ `embedding_status`

### 12.3 Commitments: –¥—É–±–ª–∏/–æ—à–∏–±–∫–∏
- dedup –∏–Ω–¥–µ–∫—Å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí upsert –æ–±—è–∑–∞–Ω –±—ã—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º (‚úÖ —Å–¥–µ–ª–∞–Ω–æ)

---

## 13) –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Ä–∞–±–æ—Ç (Roadmap)

### P0 (–Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å/–º–∞—Å—à—Ç–∞–±/—Å—Ç–æ–∏–º–æ—Å—Ç—å)
- üó∫Ô∏è organizations/users/memberships + organization_id –Ω–∞ projects
- üó∫Ô∏è usage_events
- üó∫Ô∏è embedding search (match_rag_chunks)
- üó∫Ô∏è automation-worker + queues + DLQ + idempotency
- üó∫Ô∏è structured logs + correlation_id

### P1 (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –¥–ª—è PM/CRM)
- üó∫Ô∏è commitments lifecycle UI
- üß™ Linear actions —á–µ—Ä–µ–∑ jobs
- üß™ Attio patch preview/apply
- üó∫Ô∏è weekly digest

### P2 (—É—Å–∏–ª–∏—Ç–µ–ª–∏)
- üó∫Ô∏è onboarding wizard
- üó∫Ô∏è billing hooks/–ª–∏–º–∏—Ç—ã
- üó∫Ô∏è –º—É–ª—å—Ç–∏‚Äë–∫–∞–Ω–∞–ª—å–Ω–æ—Å—Ç—å

---

## 14) –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π)

### –î–µ–ø–ª–æ–π
- ‚úÖ `Deploy (dev)` ‚Äî auto –Ω–∞ push –≤ `main`
- ‚úÖ `Deploy (prod)` ‚Äî manual

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
`tgbot`:
- ‚úÖ `GET /__whoami`
- ‚úÖ `GET /__env`
- ‚úÖ `GET /health`

`cw-sync`:
- ‚úÖ `GET /health`
- ‚úÖ `GET /sync` (Bearer `SYNC_TOKEN`)
- ‚úÖ `GET /embed` (Bearer `SYNC_TOKEN`)
