# Спека 0001 — Мультипроектная изоляция памяти (RAG) (READY)

Статус: **ready**

## Цель

Сделать так, чтобы любая «память» (переписки, фрагменты, эмбеддинги, поиск) была **жёстко изолирована по проектам**.

Ключевое требование: **внутри проекта нельзя увидеть данные другого проекта**, даже случайно.

## Не-цели

- Организации/тенанты (multi-tenant)
- Роли/права доступа
- Backfill старых данных по проектам (для MVP сознательно пропускаем)

## Почему это критично

Студия ведёт много проектов. Если система хоть раз смешает контекст, доверие к продукту ломается.

## Семантика связывания «проект ↔ Chatwoot»

### Проблема

Один и тот же контакт/компания может фигурировать в нескольких проектах. Поэтому «контакт = проект» — опасная связка.

### Решение v1 (рекомендуемое)

**Единица привязки = Inbox в Chatwoot.**

Смысл:

- Проект в нашей системе имеет список «инбоксов Chatwoot, которые относятся к этому проекту».
- Переписки из не привязанных инбоксов **не попадают** в базу знаний.

Почему так:

- Inbox — устойчивая операционная единица.
- PM может настроить один раз и забыть.
- Это безопасно: если нет привязки — ничего не импортируем.

### Безопасное поведение по умолчанию

Если переписка не может быть однозначно привязана к проекту, система должна:

- **не импортировать** её в память
- **не выдавать** её в поиске
- **зафиксировать** факт пропуска в журнале/статусе импорта

### Изменение привязки (важное UX-правило)

Если inbox переназначили другому проекту:

- новые данные пойдут в новый проект
- **исторические данные не “переезжают” автоматически**
- UI должен предупреждать об этом

## Поведение системы

### Импорт переписок

Система периодически импортирует переписки из Chatwoot.

При импорте:

- каждая импортированная сущность (переписка/сообщение/фрагмент) получает «маркер проекта»
- переписки, которые не относятся ни к одному проекту, не импортируются
- повторные импорты не создают дублей

### Построение памяти

- Память строится только из импортированных данных.
- Любой фрагмент памяти всегда относится к конкретному проекту.

### Поиск

- Поиск всегда выполняется **в контексте активного проекта**.
- Результаты поиска никогда не содержат данные других проектов.
- Старые/неразмеченные данные считаются недоступными.

### Наблюдаемость

Пользователь должен видеть:

- сколько переписок/сообщений/фрагментов добавлено в память
- сколько пропущено из-за отсутствия привязки
- какие проекты обновились

## Анти-паттерны (запрещено)

- определять проект по домену email/названию компании (слишком много ложных срабатываний)
- хранить “общую память студии” без строгой фильтрации (утечки)
- показывать “немаркированные” данные (legacy) хоть где-то в UI

## UX (как это ощущается)

1) Пользователь создаёт проект.
2) Пользователь связывает проект с нужными inbox в Chatwoot.
3) Пользователь запускает импорт.
4) Пользователь выбирает проект активным.
5) Пользователь строит память (или она строится по расписанию).
6) Пользователь использует поиск и получает только проектный контекст.

## Acceptance criteria

1. При наличии двух проектов A и B поиск в A **никогда** не показывает данные B.
2. Если inbox не привязан — его переписки **не импортируются**.
3. Любая сущность памяти имеет маркер проекта.
4. Повторный запуск импорта/построения не создаёт дубликаты.
5. Пользователь видит «почему ничего не импортировалось», если нет привязок.
