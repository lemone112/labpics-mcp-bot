# Спека 0001 — Мультипроектная изоляция памяти (RAG) (READY)

Статус: **ready**

## Цель

Сделать так, чтобы любая «память» (переписки, чанки, эмбеддинги, поиск) была **жёстко изолирована по проектам**.

Ключевое требование: **внутри проекта нельзя увидеть данные другого проекта**, даже случайно.

## Не-цели

- Организации/тенанты (multi-tenant)
- Роли/права доступа
- Backfill старых данных по проектам (для MVP сознательно пропускаем)

## Почему это критично

Дизайн-студия ведёт много проектов. Если система хоть раз смешает контекст, доверие к продукту ломается.

## Как проект «привязывается» к Chatwoot (семантика)

### Проблема

Один и тот же контакт/компания может фигурировать в нескольких проектах. Поэтому «контакт = проект» — опасная связка.

### Решение v1 (рекомендуемое)

**Единица привязки = Inbox в Chatwoot.**

Смысл:

- Проект в нашей системе имеет список «инбоксов Chatwoot, которые относятся к этому проекту».
- Переписки из не привязанных инбоксов **не попадают** в базу знаний.

Почему так:

- Inbox — устойчивая операционная единица.
- PM может настроить один раз и забыть.
- Это безопасно: если нет привязки — ничего не импортируем.

### Безопасное поведение по умолчанию

Если переписка не может быть однозначно привязана к проекту, система должна:

- **не импортировать** её в память
- **не выдавать** её в поиске
- **зафиксировать** факт пропуска в журнале/статусе джобы

## Поведение системы (что должно происходить)

### Импорт переписок

Система периодически импортирует переписки из Chatwoot.

При импорте:

- каждая импортированная сущность (переписка/сообщение/фрагмент) получает «маркер проекта»
- переписки, которые не относятся ни к одному проекту, не импортируются

### Построение памяти (чанки/эмбеддинги)

- Память строится только из импортированных данных.
- Любой фрагмент памяти всегда относится к конкретному проекту.

### Поиск

- Поиск всегда выполняется **в контексте активного проекта**.
- Результаты поиска никогда не содержат данные других проектов.
- Старые/неразмеченные данные считаются недоступными.

### Статусы и наблюдаемость

Пользователь должен видеть:

- сколько переписок/сообщений/фрагментов добавлено в память
- сколько пропущено из-за отсутствия привязки к проекту
- для каких проектов обновлялась «точка синхронизации»

## UX (как это должно ощущаться)

1) Пользователь создаёт проект.
2) Пользователь связывает проект с нужными inbox в Chatwoot.
3) Пользователь запускает импорт.
4) Пользователь выбирает проект активным.
5) Пользователь запускает построение эмбеддингов (или оно происходит автоматически по расписанию).
6) Пользователь использует поиск и получает только релевантный проектный контекст.

## Acceptance criteria

1. При наличии двух проектов A и B поиск в A **никогда** не показывает данные B.
2. Если inbox не привязан к проекту — его переписки **не импортируются**.
3. Любая выдача/сущность «памяти» имеет привязку к проекту.
4. Повторный запуск импорта/эмбеддингов не создаёт мусор/дубли (идемпотентность).

## Замечания для реализации (минимально)

- Привязку «inbox → проект» хранить в БД.
- В журнале джобы фиксировать пропуски.
- Везде, где есть «память», фильтрация по проекту должна быть строгой.
