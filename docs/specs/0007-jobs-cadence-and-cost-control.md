# Спека 0007 — Cadence джоб и контроль стоимости (DRAFT)

Статус: **draft**

## Цель

Сделать автоматизацию предсказуемой, дешёвой и управляемой:

- синк источников не перегружает систему
- эмбеддинги и LLM не сжигают бюджет
- любой процесс можно безопасно повторить
- пользователь понимает “что сейчас происходит”

## Принципы

1. **Дефолт = экономно.** Автоматизация не должна работать “на максимуме” без необходимости.
2. **Bounded work.** Любая джоба делает ограниченный объём работы за запуск.
3. **Backoff.** При ошибках/лимитах система снижает частоту и сообщает.
4. **Понятные статусы.** Пользователь видит прогресс и причину остановки.
5. **Кнопка важнее cron.** Даже если cron есть, всегда должна быть кнопка “запустить сейчас”.

## Классы джоб

### 1) Ingestion (импорт)

Примеры: Chatwoot sync, Linear sync, Attio sync.

Семантика:

- импортируем только то, что относится к проекту (см. 0001/0006)
- импорт идемпотентен
- импорт обновляет “точку синхронизации”

### 2) Memory build (построение памяти)

Примеры: chunking, embeddings.

Семантика:

- память строится только из импортированных данных
- объём за запуск ограничен
- ошибки эмбеддинга не ломают весь пайплайн

### 3) Extraction (извлечение сущностей)

Примеры: commitments, risks.

Семантика:

- извлечение работает по новой памяти
- применяет «ворота уверенности» (предложено/активно)
- не создаёт дублей

### 4) Reporting (сводки)

Примеры: weekly digest.

Семантика:

- формируется по периоду
- сохраняется версиями

### 5) Actions (preview/apply)

Примеры: Linear/Attio предложения.

Семантика:

- preview безопасен
- apply всегда аудируется

## Cadence (рекомендуемое поведение)

### Почти realtime (если нужно)

- Импорт переписок: каждые 10–15 минут

Условие: только если есть активные проекты с привязками.

### Батчево

- Embeddings: каждые 30–60 минут или по кнопке
- Extract commitments/risks: 1–2 раза в день или по кнопке

### Weekly

- Digest: weekly + “Generate now”

## Контроль стоимости

### Правила, которые всегда должны работать

1. **Лимит сообщений/фрагментов на запуск** (bounded batches).
2. **Дедуп**: не эмбеддить один и тот же текст повторно.
3. **Приоритеты**:
   - сначала новые проекты/активные проекты
   - потом всё остальное
4. **Окна обработки**:
   - свежие данные важнее исторических

### Поведение при росте стоимости

- UI показывает “сколько примерно стоило” (хотя бы относительными метриками: N embeddings, N LLM calls).
- Можно снизить интенсивность (переключатель “экономный режим”).

## Управление и наблюдаемость

Пользователь должен видеть:

- какие джобы существуют
- их статус (idle/running/ok/failed)
- когда был последний успешный запуск
- сколько обработано
- почему пропустили/остановили (например: нет привязок, нет ключа, rate limit)

## Режимы запуска

- Автоматически (по расписанию)
- Вручную (кнопка)

При конфликте:

- если уже выполняется — второй запуск не должен порождать хаос (либо в очередь, либо отказ с объяснением)

## Acceptance criteria

1. Джобы не “убегают” бесконечно: каждый запуск ограничен.
2. При ошибках есть backoff и понятная причина.
3. Пользователь может всегда нажать “запустить сейчас”.
4. Система не эмбеддит одно и то же повторно.
5. Есть минимальный контроль стоимости и видимость в UI.
