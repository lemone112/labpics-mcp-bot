name: Deploy (dev)

on:
  push:
    branches: [main]
    paths:
      - "server/**"
      - "web/**"
      - "docker-compose.yml"
      - ".github/workflows/deploy-dev.yml"

concurrency:
  group: web-dev-deploy
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Validate server
        working-directory: server
        run: |
          set -euo pipefail
          npm ci
          node --check src/index.js

      - name: Validate web
        working-directory: web
        env:
          NEXT_PUBLIC_API_BASE_URL: ${{ vars.NEXT_PUBLIC_API_BASE_URL }}
        run: |
          set -euo pipefail
          npm ci
          npm run build

  deploy-dev:
    runs-on: ubuntu-latest
    environment: dev
    needs: validate
    permissions:
      contents: read
    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      DEPLOY_PATH: ${{ vars.DEPLOY_PATH }}
      COMPOSE_PROJECT_NAME: ${{ vars.COMPOSE_PROJECT_NAME }}
      POSTGRES_DB: ${{ vars.POSTGRES_DB }}
      POSTGRES_USER: ${{ vars.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      DB_PORT: ${{ vars.DB_PORT }}
      API_PORT: ${{ vars.API_PORT }}
      WEB_PORT: ${{ vars.WEB_PORT }}
      NEXT_PUBLIC_API_BASE_URL: ${{ vars.NEXT_PUBLIC_API_BASE_URL }}
      CORS_ORIGIN: ${{ vars.CORS_ORIGIN }}
      AUTH_USERNAME: ${{ vars.AUTH_USERNAME }}
      AUTH_PASSWORD: ${{ secrets.AUTH_PASSWORD }}
      SESSION_COOKIE_NAME: ${{ vars.SESSION_COOKIE_NAME }}
      CHATWOOT_BASE_URL: ${{ vars.CHATWOOT_BASE_URL }}
      CHATWOOT_ACCOUNT_ID: ${{ vars.CHATWOOT_ACCOUNT_ID }}
      CHATWOOT_API_TOKEN: ${{ secrets.CHATWOOT_API_TOKEN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      EMBEDDING_MODEL: ${{ vars.EMBEDDING_MODEL }}
      EMBED_BATCH_SIZE: ${{ vars.EMBED_BATCH_SIZE }}
      CHUNK_SIZE: ${{ vars.CHUNK_SIZE }}
      MIN_EMBED_CHARS: ${{ vars.MIN_EMBED_CHARS }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure SSH key
        run: |
          set -euo pipefail
          install -d -m 700 ~/.ssh
          printf "%s" "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Sync repository to remote
        run: |
          set -euo pipefail
          remote_path="${DEPLOY_PATH:-/opt/labpics-web-dev}"
          ssh "$SSH_USER@$SSH_HOST" "mkdir -p '$remote_path'"
          rsync -az --delete \
            --exclude '.git' \
            --exclude '**/node_modules' \
            --exclude '**/.next' \
            --exclude '.env' \
            ./ "$SSH_USER@$SSH_HOST:$remote_path/"

      - name: Upload environment file
        run: |
          set -euo pipefail
          remote_path="${DEPLOY_PATH:-/opt/labpics-web-dev}"
          cat > .env.deploy <<EOF
          POSTGRES_DB=${POSTGRES_DB:-labpics}
          POSTGRES_USER=${POSTGRES_USER:-app}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-app}
          DB_PORT=${DB_PORT:-5432}
          API_PORT=${API_PORT:-8080}
          WEB_PORT=${WEB_PORT:-3000}
          NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8080}
          CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000}
          AUTH_USERNAME=${AUTH_USERNAME:-admin}
          AUTH_PASSWORD=${AUTH_PASSWORD:-admin}
          SESSION_COOKIE_NAME=${SESSION_COOKIE_NAME:-sid}
          CHATWOOT_BASE_URL=${CHATWOOT_BASE_URL:-https://app.chatwoot.com}
          CHATWOOT_ACCOUNT_ID=${CHATWOOT_ACCOUNT_ID:-123}
          CHATWOOT_API_TOKEN=${CHATWOOT_API_TOKEN}
          OPENAI_API_KEY=${OPENAI_API_KEY}
          EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
          EMBED_BATCH_SIZE=${EMBED_BATCH_SIZE:-100}
          CHUNK_SIZE=${CHUNK_SIZE:-1000}
          MIN_EMBED_CHARS=${MIN_EMBED_CHARS:-30}
          EOF
          scp .env.deploy "$SSH_USER@$SSH_HOST:$remote_path/.env"

      - name: Deploy compose stack
        run: |
          set -euo pipefail
          remote_path="${DEPLOY_PATH:-/opt/labpics-web-dev}"
          compose_project="${COMPOSE_PROJECT_NAME:-labpics-dev}"
          ssh "$SSH_USER@$SSH_HOST" "cd '$remote_path' && COMPOSE_PROJECT_NAME='$compose_project' docker compose --env-file .env up -d --build --remove-orphans"

      - name: Smoke check remote services
        run: |
          set -euo pipefail
          api_port="${API_PORT:-8080}"
          web_port="${WEB_PORT:-3000}"
          ssh "$SSH_USER@$SSH_HOST" "curl -fsS http://127.0.0.1:${api_port}/health >/dev/null"
          ssh "$SSH_USER@$SSH_HOST" "curl -fsS http://127.0.0.1:${web_port}/login >/dev/null"
