name: Deploy (prod)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to deploy (branch or tag)"
        required: false
        default: "cursor/labpics_dashboard"

concurrency:
  group: web-prod-deploy
  cancel-in-progress: false

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref_name }}

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Validate server
        working-directory: server
        run: |
          set -euo pipefail
          npm ci
          while IFS= read -r file; do
            node --check "$file"
          done < <(find src -name "*.js" -type f | sort)

      - name: Validate web
        working-directory: web
        run: |
          set -euo pipefail
          npm ci
          npm run lint
          npm run build

  deploy-prod:
    runs-on: self-hosted
    environment: production
    needs: validate
    permissions:
      contents: read
    env:
      COMPOSE_PROJECT_NAME: ${{ vars.COMPOSE_PROJECT_NAME }}
      POSTGRES_DB: ${{ vars.POSTGRES_DB }}
      POSTGRES_USER: ${{ vars.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      DB_PORT: ${{ vars.DB_PORT }}
      API_PORT: ${{ vars.API_PORT }}
      WEB_PORT: ${{ vars.WEB_PORT }}
      EDGE_HTTP_PORT: ${{ vars.EDGE_HTTP_PORT }}
      EDGE_HTTPS_PORT: ${{ vars.EDGE_HTTPS_PORT }}
      NEXT_PUBLIC_API_BASE_URL: ${{ vars.NEXT_PUBLIC_API_BASE_URL }}
      API_UPSTREAM_URL: ${{ vars.API_UPSTREAM_URL }}
      CORS_ORIGIN: https://dashboard.lab.pics
      DOMAIN: dashboard.lab.pics
      API_UPSTREAM: ${{ vars.API_UPSTREAM }}
      WEB_UPSTREAM: ${{ vars.WEB_UPSTREAM }}
      ENABLE_EDGE_PROXY: ${{ vars.ENABLE_EDGE_PROXY }}
      EDGE_BASIC_AUTH_ENABLED: ${{ vars.EDGE_BASIC_AUTH_ENABLED }}
      EDGE_BASIC_AUTH_USER: ${{ vars.EDGE_BASIC_AUTH_USER }}
      EDGE_BASIC_AUTH_PASSWORD_HASH: ${{ secrets.EDGE_BASIC_AUTH_PASSWORD_HASH }}
      AUTH_USERNAME: ${{ vars.AUTH_USERNAME }}
      AUTH_PASSWORD: ${{ secrets.AUTH_PASSWORD }}
      SESSION_COOKIE_NAME: ${{ vars.SESSION_COOKIE_NAME }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_WEBHOOK_SECRET: ${{ secrets.TELEGRAM_WEBHOOK_SECRET }}
      SIGNUP_PIN_SECRET: ${{ secrets.SIGNUP_PIN_SECRET }}
      SIGNUP_PIN_TTL_MINUTES: ${{ vars.SIGNUP_PIN_TTL_MINUTES }}
      SIGNUP_PIN_MAX_ATTEMPTS: ${{ vars.SIGNUP_PIN_MAX_ATTEMPTS }}
      CHATWOOT_BASE_URL: ${{ vars.CHATWOOT_BASE_URL }}
      CHATWOOT_ACCOUNT_ID: ${{ vars.CHATWOOT_ACCOUNT_ID }}
      CHATWOOT_API_TOKEN: ${{ secrets.CHATWOOT_API_TOKEN }}
      CHATWOOT_CONVERSATIONS_LIMIT: ${{ vars.CHATWOOT_CONVERSATIONS_LIMIT }}
      CHATWOOT_CONVERSATIONS_PER_PAGE: ${{ vars.CHATWOOT_CONVERSATIONS_PER_PAGE }}
      CHATWOOT_PAGES_LIMIT: ${{ vars.CHATWOOT_PAGES_LIMIT }}
      CHATWOOT_MESSAGES_LIMIT: ${{ vars.CHATWOOT_MESSAGES_LIMIT }}
      CHATWOOT_LOOKBACK_DAYS: ${{ vars.CHATWOOT_LOOKBACK_DAYS }}
      ATTIO_BASE_URL: ${{ vars.ATTIO_BASE_URL }}
      ATTIO_WORKSPACE_ID: ${{ vars.ATTIO_WORKSPACE_ID }}
      ATTIO_API_TOKEN: ${{ secrets.ATTIO_API_TOKEN }}
      ATTIO_SYNC_LIMIT: ${{ vars.ATTIO_SYNC_LIMIT }}
      ATTIO_MOCK_MODE: ${{ vars.ATTIO_MOCK_MODE }}
      LINEAR_BASE_URL: ${{ vars.LINEAR_BASE_URL }}
      LINEAR_WORKSPACE_ID: ${{ vars.LINEAR_WORKSPACE_ID }}
      LINEAR_API_TOKEN: ${{ secrets.LINEAR_API_TOKEN }}
      LINEAR_SYNC_LIMIT: ${{ vars.LINEAR_SYNC_LIMIT }}
      LINEAR_MOCK_MODE: ${{ vars.LINEAR_MOCK_MODE }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      EMBEDDING_MODEL: ${{ vars.EMBEDDING_MODEL }}
      EMBEDDING_DIM: ${{ vars.EMBEDDING_DIM }}
      EMBED_BATCH_SIZE: ${{ vars.EMBED_BATCH_SIZE }}
      OPENAI_EMBED_MAX_INPUTS: ${{ vars.OPENAI_EMBED_MAX_INPUTS }}
      OPENAI_TIMEOUT_MS: ${{ vars.OPENAI_TIMEOUT_MS }}
      EMBED_STALE_RECOVERY_MINUTES: ${{ vars.EMBED_STALE_RECOVERY_MINUTES }}
      CHUNK_SIZE: ${{ vars.CHUNK_SIZE }}
      MIN_EMBED_CHARS: ${{ vars.MIN_EMBED_CHARS }}
      SEARCH_IVFFLAT_PROBES: ${{ vars.SEARCH_IVFFLAT_PROBES }}
      SEARCH_HNSW_EF_SEARCH: ${{ vars.SEARCH_HNSW_EF_SEARCH }}
      STORAGE_BUDGET_GB: ${{ vars.STORAGE_BUDGET_GB }}
      STORAGE_ALERT_THRESHOLD_PCT: ${{ vars.STORAGE_ALERT_THRESHOLD_PCT }}
      WORKER_INTERVAL_SECONDS: ${{ vars.WORKER_INTERVAL_SECONDS }}
      WORKER_TICK_LIMIT: ${{ vars.WORKER_TICK_LIMIT }}
      CSRF_COOKIE_NAME: ${{ vars.CSRF_COOKIE_NAME }}
      NEXT_PUBLIC_CSRF_COOKIE_NAME: ${{ vars.NEXT_PUBLIC_CSRF_COOKIE_NAME }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref_name }}

      - name: Check Docker Compose
        run: |
          set -euo pipefail
          docker compose version

      - name: Render environment file
        run: |
          set -euo pipefail
          cat > .env <<EOF
          POSTGRES_DB=${POSTGRES_DB:-labpics}
          POSTGRES_USER=${POSTGRES_USER:-app}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-app}
          DB_PORT=${DB_PORT:-5432}
          API_PORT=${API_PORT:-8080}
          WEB_PORT=${WEB_PORT:-3000}
          EDGE_HTTP_PORT=${EDGE_HTTP_PORT:-80}
          EDGE_HTTPS_PORT=${EDGE_HTTPS_PORT:-443}
          NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-/api}
          API_UPSTREAM_URL=${API_UPSTREAM_URL:-http://server:8080}
          DOMAIN=${DOMAIN}
          API_UPSTREAM=${API_UPSTREAM:-server:8080}
          WEB_UPSTREAM=${WEB_UPSTREAM:-web:3000}
          CORS_ORIGIN=${CORS_ORIGIN}
          ENABLE_EDGE_PROXY=${ENABLE_EDGE_PROXY:-true}
          EDGE_BASIC_AUTH_ENABLED=${EDGE_BASIC_AUTH_ENABLED:-false}
          EDGE_BASIC_AUTH_USER=${EDGE_BASIC_AUTH_USER:-}
          EDGE_BASIC_AUTH_PASSWORD_HASH=${EDGE_BASIC_AUTH_PASSWORD_HASH:-}
          NODE_ENV=production
          AUTH_USERNAME=${AUTH_USERNAME:-admin}
          AUTH_PASSWORD=${AUTH_PASSWORD:-admin}
          SESSION_COOKIE_NAME=${SESSION_COOKIE_NAME:-sid}
          TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
          TELEGRAM_WEBHOOK_SECRET=${TELEGRAM_WEBHOOK_SECRET:-}
          SIGNUP_PIN_SECRET=${SIGNUP_PIN_SECRET:-}
          SIGNUP_PIN_TTL_MINUTES=${SIGNUP_PIN_TTL_MINUTES:-10}
          SIGNUP_PIN_MAX_ATTEMPTS=${SIGNUP_PIN_MAX_ATTEMPTS:-8}
          CHATWOOT_BASE_URL=${CHATWOOT_BASE_URL:-https://app.chatwoot.com}
          CHATWOOT_ACCOUNT_ID=${CHATWOOT_ACCOUNT_ID:-123}
          CHATWOOT_API_TOKEN=${CHATWOOT_API_TOKEN}
          CHATWOOT_CONVERSATIONS_LIMIT=${CHATWOOT_CONVERSATIONS_LIMIT:-60}
          CHATWOOT_CONVERSATIONS_PER_PAGE=${CHATWOOT_CONVERSATIONS_PER_PAGE:-25}
          CHATWOOT_PAGES_LIMIT=${CHATWOOT_PAGES_LIMIT:-20}
          CHATWOOT_MESSAGES_LIMIT=${CHATWOOT_MESSAGES_LIMIT:-300}
          CHATWOOT_LOOKBACK_DAYS=${CHATWOOT_LOOKBACK_DAYS:-7}
          ATTIO_BASE_URL=${ATTIO_BASE_URL:-https://api.attio.com}
          ATTIO_WORKSPACE_ID=${ATTIO_WORKSPACE_ID:-}
          ATTIO_API_TOKEN=${ATTIO_API_TOKEN:-}
          ATTIO_SYNC_LIMIT=${ATTIO_SYNC_LIMIT:-200}
          ATTIO_MOCK_MODE=${ATTIO_MOCK_MODE:-1}
          LINEAR_BASE_URL=${LINEAR_BASE_URL:-https://api.linear.app/graphql}
          LINEAR_WORKSPACE_ID=${LINEAR_WORKSPACE_ID:-}
          LINEAR_API_TOKEN=${LINEAR_API_TOKEN:-}
          LINEAR_SYNC_LIMIT=${LINEAR_SYNC_LIMIT:-200}
          LINEAR_MOCK_MODE=${LINEAR_MOCK_MODE:-1}
          OPENAI_API_KEY=${OPENAI_API_KEY}
          EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
          EMBEDDING_DIM=${EMBEDDING_DIM:-1536}
          EMBED_BATCH_SIZE=${EMBED_BATCH_SIZE:-100}
          OPENAI_EMBED_MAX_INPUTS=${OPENAI_EMBED_MAX_INPUTS:-100}
          OPENAI_TIMEOUT_MS=${OPENAI_TIMEOUT_MS:-20000}
          EMBED_STALE_RECOVERY_MINUTES=${EMBED_STALE_RECOVERY_MINUTES:-30}
          CHUNK_SIZE=${CHUNK_SIZE:-1000}
          MIN_EMBED_CHARS=${MIN_EMBED_CHARS:-30}
          SEARCH_IVFFLAT_PROBES=${SEARCH_IVFFLAT_PROBES:-10}
          SEARCH_HNSW_EF_SEARCH=${SEARCH_HNSW_EF_SEARCH:-40}
          STORAGE_BUDGET_GB=${STORAGE_BUDGET_GB:-20}
          STORAGE_ALERT_THRESHOLD_PCT=${STORAGE_ALERT_THRESHOLD_PCT:-85}
          WORKER_INTERVAL_SECONDS=${WORKER_INTERVAL_SECONDS:-60}
          WORKER_TICK_LIMIT=${WORKER_TICK_LIMIT:-25}
          CSRF_COOKIE_NAME=${CSRF_COOKIE_NAME:-csrf_token}
          NEXT_PUBLIC_CSRF_COOKIE_NAME=${NEXT_PUBLIC_CSRF_COOKIE_NAME:-csrf_token}
          EOF

      - name: Deploy compose stack
        run: |
          set -euo pipefail
          compose_project="${COMPOSE_PROJECT_NAME:-labpics-prod}"
          if [ "${ENABLE_EDGE_PROXY:-true}" = "true" ]; then
            COMPOSE_PROJECT_NAME="$compose_project" docker compose --profile edge --env-file .env up -d --build --remove-orphans
          else
            COMPOSE_PROJECT_NAME="$compose_project" docker compose --env-file .env up -d --build --remove-orphans
          fi

      - name: Smoke check remote services
        run: |
          set -euo pipefail
          api_port="${API_PORT:-8080}"
          web_port="${WEB_PORT:-3000}"
          wait_for_url() {
            local url="$1"
            local attempts="${2:-30}"
            local sleep_s="${3:-2}"
            local i=1
            while [ "$i" -le "$attempts" ]; do
              if curl -fsS --max-time 10 "$url" >/dev/null; then
                return 0
              fi
              echo "waiting for $url ($i/$attempts)"
              sleep "$sleep_s"
              i=$((i + 1))
            done
            echo "smoke check failed for $url" >&2
            return 1
          }

          wait_for_url "http://127.0.0.1:${api_port}/health"
          wait_for_url "http://127.0.0.1:${web_port}/login"
          wait_for_url "http://127.0.0.1:${web_port}/projects"
          wait_for_url "http://127.0.0.1:${web_port}/jobs"
          wait_for_url "http://127.0.0.1:${web_port}/search"
          wait_for_url "http://127.0.0.1:${web_port}/control-tower"
          if [ "${ENABLE_EDGE_PROXY:-true}" = "true" ]; then
            domain="${DOMAIN}"
            wait_for_url "https://${domain}/login" 40 3
          fi
