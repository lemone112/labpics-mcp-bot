name: Deploy (prod)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to deploy (branch or tag)"
        required: false
        default: "cursor/labpics_dashboard"

concurrency:
  group: web-prod-deploy
  cancel-in-progress: false

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref_name }}

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Validate server
        working-directory: server
        run: |
          set -euo pipefail
          npm ci
          node --check src/index.js

      - name: Validate web
        working-directory: web
        run: |
          set -euo pipefail
          npm ci
          npm run build

  deploy-prod:
    runs-on: ubuntu-latest
    environment: production
    needs: validate
    permissions:
      contents: read
    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      DEPLOY_PATH: ${{ vars.DEPLOY_PATH }}
      COMPOSE_PROJECT_NAME: ${{ vars.COMPOSE_PROJECT_NAME }}
      POSTGRES_DB: ${{ vars.POSTGRES_DB }}
      POSTGRES_USER: ${{ vars.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      DB_PORT: ${{ vars.DB_PORT }}
      API_PORT: ${{ vars.API_PORT }}
      WEB_PORT: ${{ vars.WEB_PORT }}
      EDGE_HTTP_PORT: ${{ vars.EDGE_HTTP_PORT }}
      EDGE_HTTPS_PORT: ${{ vars.EDGE_HTTPS_PORT }}
      NEXT_PUBLIC_API_BASE_URL: ${{ vars.NEXT_PUBLIC_API_BASE_URL }}
      API_UPSTREAM_URL: ${{ vars.API_UPSTREAM_URL }}
      CORS_ORIGIN: ${{ vars.CORS_ORIGIN }}
      DOMAIN: ${{ vars.DOMAIN }}
      API_UPSTREAM: ${{ vars.API_UPSTREAM }}
      WEB_UPSTREAM: ${{ vars.WEB_UPSTREAM }}
      ENABLE_EDGE_PROXY: ${{ vars.ENABLE_EDGE_PROXY }}
      AUTH_USERNAME: ${{ vars.AUTH_USERNAME }}
      AUTH_PASSWORD: ${{ secrets.AUTH_PASSWORD }}
      SESSION_COOKIE_NAME: ${{ vars.SESSION_COOKIE_NAME }}
      CHATWOOT_BASE_URL: ${{ vars.CHATWOOT_BASE_URL }}
      CHATWOOT_ACCOUNT_ID: ${{ vars.CHATWOOT_ACCOUNT_ID }}
      CHATWOOT_API_TOKEN: ${{ secrets.CHATWOOT_API_TOKEN }}
      CHATWOOT_CONVERSATIONS_LIMIT: ${{ vars.CHATWOOT_CONVERSATIONS_LIMIT }}
      CHATWOOT_CONVERSATIONS_PER_PAGE: ${{ vars.CHATWOOT_CONVERSATIONS_PER_PAGE }}
      CHATWOOT_PAGES_LIMIT: ${{ vars.CHATWOOT_PAGES_LIMIT }}
      CHATWOOT_MESSAGES_LIMIT: ${{ vars.CHATWOOT_MESSAGES_LIMIT }}
      CHATWOOT_LOOKBACK_DAYS: ${{ vars.CHATWOOT_LOOKBACK_DAYS }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      EMBEDDING_MODEL: ${{ vars.EMBEDDING_MODEL }}
      EMBEDDING_DIM: ${{ vars.EMBEDDING_DIM }}
      EMBED_BATCH_SIZE: ${{ vars.EMBED_BATCH_SIZE }}
      OPENAI_EMBED_MAX_INPUTS: ${{ vars.OPENAI_EMBED_MAX_INPUTS }}
      OPENAI_TIMEOUT_MS: ${{ vars.OPENAI_TIMEOUT_MS }}
      EMBED_STALE_RECOVERY_MINUTES: ${{ vars.EMBED_STALE_RECOVERY_MINUTES }}
      CHUNK_SIZE: ${{ vars.CHUNK_SIZE }}
      MIN_EMBED_CHARS: ${{ vars.MIN_EMBED_CHARS }}
      SEARCH_IVFFLAT_PROBES: ${{ vars.SEARCH_IVFFLAT_PROBES }}
      SEARCH_HNSW_EF_SEARCH: ${{ vars.SEARCH_HNSW_EF_SEARCH }}
      STORAGE_BUDGET_GB: ${{ vars.STORAGE_BUDGET_GB }}
      STORAGE_ALERT_THRESHOLD_PCT: ${{ vars.STORAGE_ALERT_THRESHOLD_PCT }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref_name }}

      - name: Configure SSH key
        run: |
          set -euo pipefail
          : "${SSH_HOST:?Missing SSH_HOST secret}"
          : "${SSH_USER:?Missing SSH_USER secret}"
          : "${SSH_PRIVATE_KEY:?Missing SSH_PRIVATE_KEY secret}"
          install -d -m 700 ~/.ssh
          raw_key="$(printf "%s" "$SSH_PRIVATE_KEY" | tr -d '\r')"
          printf "%s" "$raw_key" | sed 's/\\n/\n/g' > ~/.ssh/id_ed25519
          if ! ssh-keygen -l -f ~/.ssh/id_ed25519 >/dev/null 2>&1; then
            if printf "%s" "$raw_key" | base64 -d > ~/.ssh/id_ed25519 2>/dev/null && ssh-keygen -l -f ~/.ssh/id_ed25519 >/dev/null 2>&1; then
              echo "decoded SSH_PRIVATE_KEY from base64"
            else
              echo "SSH_PRIVATE_KEY is invalid. Use OpenSSH private key text or base64-encoded private key." >&2
              exit 255
            fi
          fi
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Sync repository to remote
        run: |
          set -euo pipefail
          remote_path="${DEPLOY_PATH:-/opt/labpics-web-prod}"
          ssh "$SSH_USER@$SSH_HOST" "mkdir -p '$remote_path'"
          rsync -az --delete \
            --exclude '.git' \
            --exclude '**/node_modules' \
            --exclude '**/.next' \
            --exclude '.env' \
            ./ "$SSH_USER@$SSH_HOST:$remote_path/"

      - name: Upload environment file
        run: |
          set -euo pipefail
          remote_path="${DEPLOY_PATH:-/opt/labpics-web-prod}"
          cat > .env.deploy <<EOF
          POSTGRES_DB=${POSTGRES_DB:-labpics}
          POSTGRES_USER=${POSTGRES_USER:-app}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-app}
          DB_PORT=${DB_PORT:-5432}
          API_PORT=${API_PORT:-8080}
          WEB_PORT=${WEB_PORT:-3000}
          EDGE_HTTP_PORT=${EDGE_HTTP_PORT:-80}
          EDGE_HTTPS_PORT=${EDGE_HTTPS_PORT:-443}
          NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-/api}
          API_UPSTREAM_URL=${API_UPSTREAM_URL:-http://server:8080}
          DOMAIN=${DOMAIN:-dashboard.lab.pics}
          API_UPSTREAM=${API_UPSTREAM:-server:8080}
          WEB_UPSTREAM=${WEB_UPSTREAM:-web:3000}
          CORS_ORIGIN=${CORS_ORIGIN:-https://dashboard.lab.pics}
          ENABLE_EDGE_PROXY=${ENABLE_EDGE_PROXY:-true}
          NODE_ENV=production
          AUTH_USERNAME=${AUTH_USERNAME:-admin}
          AUTH_PASSWORD=${AUTH_PASSWORD:-admin}
          SESSION_COOKIE_NAME=${SESSION_COOKIE_NAME:-sid}
          CHATWOOT_BASE_URL=${CHATWOOT_BASE_URL:-https://app.chatwoot.com}
          CHATWOOT_ACCOUNT_ID=${CHATWOOT_ACCOUNT_ID:-123}
          CHATWOOT_API_TOKEN=${CHATWOOT_API_TOKEN}
          CHATWOOT_CONVERSATIONS_LIMIT=${CHATWOOT_CONVERSATIONS_LIMIT:-60}
          CHATWOOT_CONVERSATIONS_PER_PAGE=${CHATWOOT_CONVERSATIONS_PER_PAGE:-25}
          CHATWOOT_PAGES_LIMIT=${CHATWOOT_PAGES_LIMIT:-20}
          CHATWOOT_MESSAGES_LIMIT=${CHATWOOT_MESSAGES_LIMIT:-300}
          CHATWOOT_LOOKBACK_DAYS=${CHATWOOT_LOOKBACK_DAYS:-7}
          OPENAI_API_KEY=${OPENAI_API_KEY}
          EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
          EMBEDDING_DIM=${EMBEDDING_DIM:-1536}
          EMBED_BATCH_SIZE=${EMBED_BATCH_SIZE:-100}
          OPENAI_EMBED_MAX_INPUTS=${OPENAI_EMBED_MAX_INPUTS:-100}
          OPENAI_TIMEOUT_MS=${OPENAI_TIMEOUT_MS:-20000}
          EMBED_STALE_RECOVERY_MINUTES=${EMBED_STALE_RECOVERY_MINUTES:-30}
          CHUNK_SIZE=${CHUNK_SIZE:-1000}
          MIN_EMBED_CHARS=${MIN_EMBED_CHARS:-30}
          SEARCH_IVFFLAT_PROBES=${SEARCH_IVFFLAT_PROBES:-10}
          SEARCH_HNSW_EF_SEARCH=${SEARCH_HNSW_EF_SEARCH:-40}
          STORAGE_BUDGET_GB=${STORAGE_BUDGET_GB:-20}
          STORAGE_ALERT_THRESHOLD_PCT=${STORAGE_ALERT_THRESHOLD_PCT:-85}
          EOF
          scp .env.deploy "$SSH_USER@$SSH_HOST:$remote_path/.env"

      - name: Deploy compose stack
        run: |
          set -euo pipefail
          remote_path="${DEPLOY_PATH:-/opt/labpics-web-prod}"
          compose_project="${COMPOSE_PROJECT_NAME:-labpics-prod}"
          if [ "${ENABLE_EDGE_PROXY:-true}" = "true" ]; then
            ssh "$SSH_USER@$SSH_HOST" "cd '$remote_path' && COMPOSE_PROJECT_NAME='$compose_project' docker compose --profile edge --env-file .env up -d --build --remove-orphans"
          else
            ssh "$SSH_USER@$SSH_HOST" "cd '$remote_path' && COMPOSE_PROJECT_NAME='$compose_project' docker compose --env-file .env up -d --build --remove-orphans"
          fi

      - name: Smoke check remote services
        run: |
          set -euo pipefail
          api_port="${API_PORT:-8080}"
          web_port="${WEB_PORT:-3000}"
          ssh "$SSH_USER@$SSH_HOST" "curl -fsS http://127.0.0.1:${api_port}/health >/dev/null"
          ssh "$SSH_USER@$SSH_HOST" "curl -fsS http://127.0.0.1:${web_port}/login >/dev/null"
          if [ "${ENABLE_EDGE_PROXY:-true}" = "true" ]; then
            domain="${DOMAIN:-dashboard.lab.pics}"
            curl -fsS "https://${domain}/login" >/dev/null
          fi
